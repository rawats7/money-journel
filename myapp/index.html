<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Secure Money Journal</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0ef2d5">

<style>
*{font-family:Cambria,Candara,"Segoe UI",serif}
body{
  margin:0;background:#061214;color:#fff;
  min-height:100vh;display:flex;
  justify-content:center;align-items:center;padding:20px
}
.app{
  width:100%;max-width:680px;
  background:#071e1d;padding:18px;
  border-radius:20px;
  box-shadow:0 0 40px rgba(14,242,213,.3)
}
button{
  width:100%;padding:12px;border:none;
  border-radius:30px;font-weight:800;
  background:linear-gradient(90deg,#0ef2d5,#13f2ff);
  margin:6px 0;cursor:pointer
}
.back{background:#444}
input,select{
  width:100%;padding:10px;border-radius:10px;
  border:none;margin:6px 0
}
.card{
  background:#05201f;padding:12px;
  border-radius:14px;margin:8px 0
}
.row{display:flex;justify-content:space-between;align-items:center}
.smallBtn{
  background:#ff4d6d;color:#fff;
  padding:4px 10px;border-radius:8px
}
.in{color:#2cff9c}
.out{color:#ff4d6d}
table{width:100%;border-collapse:collapse}
th,td{
  border-bottom:1px solid #444;
  padding:6px;text-align:center;font-size:14px
}

/* LOCK SCREEN */
#lockScreen{
  position:fixed;inset:0;background:#061214;
  display:flex;align-items:center;
  justify-content:center;z-index:9999
}
.lockBox{
  background:#071e1d;padding:24px;
  border-radius:16px;max-width:360px;width:100%
}

/* IMAGE MODAL */
#imgModal{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.9);
  align-items:center;justify-content:center;
  z-index:10000
}
#imgModal img{
  max-width:95%;max-height:95%;
  border-radius:12px
}

canvas{margin:12px 0;background:#031818;border-radius:10px}
</style>
</head>

<body>

<!-- üîí LOCK SCREEN -->
<div id="lockScreen">
  <div class="lockBox">
    <h2>üîí Secure Journal</h2>
    <input type="password" id="passInput" placeholder="Password">
    <button onclick="unlock()">Unlock</button>
    <button onclick="biometricUnlock()">üëÜ Fingerprint</button>
    <div id="lockError"></div>
  </div>
</div>

<!-- APP -->
<div class="app">
  <h2 id="title">üìÅ Folders</h2>
  <div id="view"></div>
</div>

<!-- IMAGE VIEW MODAL -->
<div id="imgModal" onclick="this.style.display='none'">
  <img id="previewImg">
</div>

<script>
/* ================= CONFIG ================= */
const STORAGE_KEY="money_journal_data";
let APP_PASSWORD=localStorage.getItem("APP_PASSWORD")||"1234";
const BIO_KEY="biometric_enabled";
const IDLE_TIME=2*60*1000;

/* ================= STATE ================= */
let data={},currentFolder=null,currentFile=null,idleTimer;

/* ================= DOM ================= */
const lockScreen=document.getElementById("lockScreen");
const passInput=document.getElementById("passInput");
const lockError=document.getElementById("lockError");
const titleEl=document.getElementById("title");
const viewEl=document.getElementById("view");

/* ================= STORAGE ================= */
function loadData(){data=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}")}
function saveData(){localStorage.setItem(STORAGE_KEY,JSON.stringify(data))}

/* ================= LOCK ================= */
function unlock(){
  if(passInput.value===APP_PASSWORD){
    lockScreen.style.display="none";
    loadData();home();resetIdle();
  }else lockError.innerText="Wrong password";
}
function lockApp(){
  lockScreen.style.display="flex";
  passInput.value="";
}

/* ================= AUTO LOCK ================= */
function resetIdle(){
  clearTimeout(idleTimer);
  idleTimer=setTimeout(lockApp,IDLE_TIME);
}
["click","mousemove","keydown","touchstart"]
.forEach(e=>document.addEventListener(e,resetIdle));

/* ================= BIOMETRIC ================= */
function isBio(){return window.PublicKeyCredential}
async function registerBiometric(){
  if(!isBio()) return alert("Not supported");
  try{
    await navigator.credentials.create({
      publicKey:{
        challenge:new Uint8Array(32),
        rp:{name:"Money Journal"},
        user:{id:new Uint8Array(16),name:"user",displayName:"User"},
        pubKeyCredParams:[{type:"public-key",alg:-7}],
        authenticatorSelection:{
          authenticatorAttachment:"platform",
          userVerification:"required"
        }
      }
    });
    localStorage.setItem(BIO_KEY,"true");
    alert("Fingerprint enabled");
  }catch(e){alert("Biometric failed")}
}
async function biometricUnlock(){
  if(localStorage.getItem(BIO_KEY)!=="true")
    return alert("Fingerprint not enabled");
  try{
    await navigator.credentials.get({
      publicKey:{
        challenge:new Uint8Array(32),
        userVerification:"required"
      }
    });
    lockScreen.style.display="none";
    loadData();home();resetIdle();
  }catch(e){alert("Fingerprint failed")}
}

/* ================= HOME ================= */
function home(){
  titleEl.innerText="üìÅ Folders";
  viewEl.innerHTML=`
    <input id="fname" placeholder="New Folder">
    <button onclick="addFolder()">‚ûï Add Folder</button>

    <button onclick="toggle('folders')">üìÇ View Folders</button>
    <div id="folders"></div>

    <button onclick="openPassword()">üîê Set New Password</button>
    <button onclick="registerBiometric()">üëÜ Enable Fingerprint</button>
  `;
  renderFolders();
}

/* ================= FOLDERS ================= */
function toggle(id){
  const d=document.getElementById(id);
  d.style.display=d.style.display==="block"?"none":"block";
}
function renderFolders(){
  const box=document.getElementById("folders");
  box.innerHTML="";
  for(let f in data){
    box.innerHTML+=`
      <div class="card row">
        <b onclick="openFolder('${f}')">üìÅ ${f}</b>
        <button onclick="folderMenu('${f}')">Update</button>
      </div>`;
  }
}
function folderMenu(f){
  const a=prompt("1 Edit | 2 Delete");
  if(a=="1"){
    const n=prompt("New name",f);
    if(n){data[n]=data[f];delete data[f];saveData();home();}
  }
  if(a=="2"&&confirm("Delete?")){
    delete data[f];saveData();home();
  }
}
function addFolder(){
  if(fname.value&&!data[fname.value]){
    data[fname.value]={};saveData();home();
  }
}

/* ================= FILES ================= */
function openFolder(f){
  currentFolder=f;
  titleEl.innerText="üìÇ "+f;
  viewEl.innerHTML=`
    <button class="back" onclick="home()">‚Üê Back</button>
    <input id="file" placeholder="New File">
    <button onclick="addFile()">‚ûï Add File</button>

    <div id="files"></div>
  `;
  renderFiles();
}
function renderFiles(){
  const box=document.getElementById("files");
  box.innerHTML="";
  for(let fi in data[currentFolder]){
    box.innerHTML+=`
      <div class="card row">
        <b onclick="openFile('${fi}')">üìÑ ${fi}</b>
        <button onclick="fileMenu('${fi}')">Update</button>
      </div>`;
  }
}
function fileMenu(f){
  const a=prompt("1 Edit | 2 Delete");
  if(a=="1"){
    const n=prompt("New name",f);
    if(n){
      data[currentFolder][n]=data[currentFolder][f];
      delete data[currentFolder][f];
      saveData();openFolder(currentFolder);
    }
  }
  if(a=="2"&&confirm("Delete?")){
    delete data[currentFolder][f];
    saveData();openFolder(currentFolder);
  }
}
function addFile(){
  if(file.value&&!data[currentFolder][file.value]){
    data[currentFolder][file.value]=[];
    saveData();openFolder(currentFolder);
  }
}

/* ================= FILE VIEW ================= */
function openFile(f){
  currentFile=f;
  const e=data[currentFolder][f];
  titleEl.innerText="üìÑ "+f;

  viewEl.innerHTML=`
    <button class="back" onclick="openFolder('${currentFolder}')">‚Üê Back</button>

    <select id="type">
      <option value="in">Money In</option>
      <option value="out">Money Out</option>
    </select>
    <input id="amt" placeholder="Amount">
    <input id="note" placeholder="Note">
    <input type="file" id="proof" accept="image/*,.pdf">

    <button onclick="addEntry()">‚ûï Add Entry</button>

    <canvas id="chart" height="220"></canvas>

    <table>
      <tr>
        <th>Type</th><th>Amount</th><th>Note</th>
        <th>Date</th><th>Proof</th><th>Action</th>
      </tr>
      ${e.map((x,i)=>`
      <tr>
        <td class="${x.type}">${x.type}</td>
        <td>${x.amt}</td>
        <td>${x.note}</td>
        <td>${new Date(x.date).toLocaleString()}</td>
        <td>
          ${
            x.proof
              ? x.proof.data.startsWith("data:image")
                ? `<img src="${x.proof.data}"
                     style="width:40px;height:40px;
                     border-radius:6px;cursor:pointer"
                     onclick="viewProof('${x.proof.data}')">
                   <div>
                     <button onclick="replaceProof(${i})">‚ôª</button>
                   </div>`
                : x.proof.name
              : `<button onclick="replaceProof(${i})">üìé</button>`
          }
        </td>
        <td><button onclick="entryMenu(${i})">Update</button></td>
      </tr>`).join("")}
    </table>
  `;
  drawChart(e);
}

/* ================= ENTRIES ================= */
function addEntry(){
  if(!amt.value) return;
  const file=proof.files[0];
  if(file){
    const r=new FileReader();
    r.onload=()=>{
      pushEntry(type.value,+amt.value,note.value,new Date(),{
        name:file.name,data:r.result
      });
    };
    r.readAsDataURL(file);
  }else{
    pushEntry(type.value,+amt.value,note.value,new Date(),null);
  }
}
function pushEntry(type,amt,note,date,proof){
  data[currentFolder][currentFile].push({type,amt,note,date,proof});
  saveData();openFile(currentFile);
}
function entryMenu(i){
  if(confirm("Delete entry?")){
    data[currentFolder][currentFile].splice(i,1);
    saveData();openFile(currentFile);
  }
}

/* ================= PROOF ACTIONS ================= */
function replaceProof(i){
  const input=document.createElement("input");
  input.type="file";
  input.accept="image/*,.pdf";
  input.onchange=()=>{
    const f=input.files[0];
    const r=new FileReader();
    r.onload=()=>{
      data[currentFolder][currentFile][i].proof={
        name:f.name,data:r.result
      };
      saveData();openFile(currentFile);
    };
    r.readAsDataURL(f);
  };
  input.click();
}
function viewProof(src){
  previewImg.src=src;
  imgModal.style.display="flex";
}

/* ================= CHART ================= */
function drawChart(entries){
  const c=document.getElementById("chart");
  const ctx=c.getContext("2d");
  let inc=0,exp=0;
  entries.forEach(e=>e.type==="in"?inc+=e.amt:exp+=e.amt);
  ctx.clearRect(0,0,c.width,c.height);
  const max=Math.max(inc,exp)||1;
  ctx.fillStyle="#2cff9c";
  ctx.fillRect(100,200-(inc/max)*180,100,(inc/max)*180);
  ctx.fillStyle="#ff4d6d";
  ctx.fillRect(260,200-(exp/max)*180,100,(exp/max)*180);
  ctx.fillStyle="#fff";
  ctx.fillText("Income ‚Çπ"+inc,110,215);
  ctx.fillText("Expense ‚Çπ"+exp,260,215);
}

/* ================= PASSWORD ================= */
function openPassword(){
  const p=prompt("New Password");
  if(p){localStorage.setItem("APP_PASSWORD",p);APP_PASSWORD=p;}
}

/* ================= PWA ================= */
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
