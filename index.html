<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secure Finance Manager</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="manifest.json">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f4f6f8}
header{background:#111;color:#fff;padding:10px;text-align:center}
button{padding:6px 10px;margin:2px;cursor:pointer}
.smallBtn{font-size:12px}
.panel{padding:10px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
input,select{padding:6px;margin:4px}
img.thumb{width:40px;height:40px;object-fit:cover;border-radius:6px;cursor:pointer}
</style>
</head>

<body>

<header>
<h3>üîê Secure Finance Manager</h3>
<button onclick="lockApp()">üîí Lock</button>
<button onclick="enableFingerprint()">üÜî Fingerprint</button>
</header>

<div class="panel" id="loginPanel">
<h3>Set / Enter Password</h3>
<input type="password" id="pwd">
<button onclick="unlock()">Unlock</button>
</div>

<div class="panel" id="app" style="display:none">

<h3>üìÅ Folder</h3>
<select id="folderSel" onchange="loadFiles()"></select>
<input id="newFolder" placeholder="New folder">
<button onclick="addFolder()">‚ûï</button>

<h3>üìÑ File</h3>
<select id="fileSel" onchange="openFile()"></select>
<input id="newFile" placeholder="New file">
<button onclick="addFile()">‚ûï</button>

<hr>

<h3>‚ûï Transaction</h3>
<input id="date" type="date">
<input id="note" placeholder="Note">
<input id="amount" type="number" placeholder="Amount">
<select id="type">
<option value="income">Income</option>
<option value="expense">Expense</option>
</select>
<input id="proof" type="file">
<button onclick="addEntry()">Save</button>

<table>
<thead>
<tr>
<th>Date</th><th>Note</th><th>Amount</th><th>Type</th><th>Proof</th><th>Action</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<hr>
<canvas id="chart"></canvas>

</div>

<!-- IMAGE MODAL -->
<div id="imgModal" style="display:none;position:fixed;inset:0;
background:rgba(0,0,0,.9);align-items:center;justify-content:center"
onclick="this.style.display='none'">
<img id="previewImg" style="max-width:90%;max-height:90%">
</div>

<script>
let data=JSON.parse(localStorage.getItem("fm")||"{}");
let currentFolder,currentFile,chart;

function save(){localStorage.setItem("fm",JSON.stringify(data));}

function unlock(){
 let p=document.getElementById("pwd").value;
 if(!localStorage.appPwd){
   localStorage.appPwd=p; alert("Password set");
 }
 if(p===localStorage.appPwd){
   loginPanel.style.display="none";
   app.style.display="block";
   loadFolders();
   startTimer();
 }
}

function lockApp(){
 app.style.display="none";
 loginPanel.style.display="block";
}

let timer;
function startTimer(){
 clearTimeout(timer);
 timer=setTimeout(lockApp,300000);
 document.onmousemove=startTimer;
 document.onkeydown=startTimer;
}

function addFolder(){
 let f=newFolder.value;
 if(!f) return;
 data[f]={};
 save();loadFolders();
}

function loadFolders(){
 folderSel.innerHTML="";
 for(let f in data){
   folderSel.innerHTML+=`<option>${f}</option>`;
 }
 loadFiles();
}

function addFile(){
 let f=folderSel.value;
 let n=newFile.value;
 if(!n) return;
 data[f][n]=[];
 save();loadFiles();
}

function loadFiles(){
 currentFolder=folderSel.value;
 fileSel.innerHTML="";
 for(let f in data[currentFolder]){
   fileSel.innerHTML+=`<option>${f}</option>`;
 }
 openFile();
}

function openFile(){
 currentFile=fileSel.value;
 rows.innerHTML="";
 let inc=0,exp=0;
 (data[currentFolder][currentFile]||[]).forEach((x,i)=>{
   if(x.type=="income")inc+=+x.amount;
   else exp+=+x.amount;

   rows.innerHTML+=`
<tr>
<td>${x.date}</td>
<td>${x.note}</td>
<td>${x.amount}</td>
<td>${x.type}</td>
<td>
${x.proof?
(x.proof.data.startsWith("data:image")?
`<img src="${x.proof.data}" class="thumb"
 onclick="viewProof('${x.proof.data}')">`
:`${x.proof.name}`)
+`<br>
<button onclick="replaceProof(${i})">‚ôª</button>
<button onclick="removeProof(${i})">üóë</button>`
:`<button onclick="replaceProof(${i})">üìé</button>`}
</td>
<td>
<button onclick="del(${i})">‚ùå</button>
</td>
</tr>`;
 });
 drawChart(inc,exp);
}

function addEntry(){
 let file=document.getElementById("proof").files[0];
 let obj={
   date:date.value,
   note:note.value,
   amount:amount.value,
   type:type.value,
   proof:null
 };
 if(file){
   let r=new FileReader();
   r.onload=()=>{
     obj.proof={name:file.name,data:r.result};
     data[currentFolder][currentFile].push(obj);
     save();openFile();
   };
   r.readAsDataURL(file);
 }else{
   data[currentFolder][currentFile].push(obj);
   save();openFile();
 }
}

function del(i){
 data[currentFolder][currentFile].splice(i,1);
 save();openFile();
}

function removeProof(i){
 data[currentFolder][currentFile][i].proof=null;
 save();openFile();
}

function replaceProof(i){
 let inp=document.createElement("input");
 inp.type="file";
 inp.onchange=()=>{
   let f=inp.files[0];
   let r=new FileReader();
   r.onload=()=>{
     data[currentFolder][currentFile][i].proof={name:f.name,data:r.result};
     save();openFile();
   };
   r.readAsDataURL(f);
 };
 inp.click();
}

function viewProof(src){
 previewImg.src=src;
 imgModal.style.display="flex";
}

function drawChart(inc,exp){
 if(chart)chart.destroy();
 chart=new Chart(document.getElementById("chart"),{
   type:"doughnut",
   data:{
     labels:["Income","Expense"],
     datasets:[{data:[inc,exp]}]
   }
 });
}

/* FINGERPRINT */
async function enableFingerprint(){
 if(!window.PublicKeyCredential){
   alert("Fingerprint not supported");
   return;
 }
 alert("Fingerprint will activate on HTTPS / localhost only");
}
</script>

</body>
</html>
